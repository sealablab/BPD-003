# Basic Probe Driver (BPD-003) – Register Map

Generic Basic Probe Driver control surface for multi-probe fault injection (FI) operations. This register specification defines the control interface for the Moku instrument firmware generated by `forge-codegen`.

---

## Platform & Configuration

| Property | Value |
|----------|-------|
| **Application** | `basic_probe_driver` |
| **Platform** | `moku_go` (default; swap to Lab/Pro for instrument-specific builds) |
| **Control Registers** | CR1–CR11 (11 registers available) |
| **Voltage Range** | ±5 V envelope (expressed in millivolts) |

> **Note:** CR0[31:29] reserved for FORGE control scheme (`forge_ready`, `user_enable`, `clk_enable`). CR12–CR15 unused (future expansion).

---

## 1. Arming and Lifecycle Management

Control the FSM state transitions and watchdog behavior. The operator's typical flow: arm the system, wait for trigger, handle faults, optionally re-arm.

| Register | Field | Bits | Type | Default | Range | Units | Description |
|----------|-------|------|------|---------|-------|-------|-------------|
| **CR1** | `arm_enable` | [0] | boolean | `false` | — | — | Enable arming of the FSM (IDLE → ARMED transition) |
| **CR1** | `ext_trigger_in` | [1] | boolean | `false` | — | — | Software-driven external trigger input for testing |
| **CR1** | `auto_rearm_enable` | [2] | boolean | `false` | — | — | When true, FSM re-enters ARMED after cooldown instead of idling |
| **CR1** | `fault_clear` | [3] | boolean | `false` | — | — | Write `1` to clear fault state and restore re-arm eligibility |
| **CR6** | `trigger_wait_timeout` | [15:0] | u16 | `2` | 0 – 3600 | s | Maximum time to wait in ARMED before timing out |

---

## 2. Output Drive Controls

Configure the two output legs: **trigger** (digital TTL-style pulse) and **intensity** (analog power/current drive). Timing and voltage levels are independently tunable.

| Register | Field | Bits | Type | Default | Range | Units | Description |
|----------|-------|------|---------|---------|-------|-------|-------------|
| **CR2** | `trig_out_voltage` | [15:0] | s16 | `0` | -5000 – 5000 | mV | Output voltage level for the digital trigger line |
| **CR3** | `trig_out_duration` | [15:0] | u16 | `100` | 20 – 50000 | ns | Duration of the `trigger_out` pulse |
| **CR4** | `intensity_voltage` | [15:0] | s16 | `0` | -5000 – 5000 | mV | Analog intensity/power control voltage delivered to the probe |
| **CR5** | `intensity_duration` | [15:0] | u16 | `200` | 20 – 50000 | ns | Duration of the intensity drive window |
| **CR7** | `cooldown_interval` | [23:0] | u24 | `10` | 1 – 500000 | µs | Cooldown dwell enforced between pulses (thermal safety) |

---

## 3. Probe Monitoring and Feedback

Real-time feedback loop for detecting probe firing via current-sense or voltage monitoring. Configurable polarity, threshold, and observation window.

| Register | Field | Bits | Type | Default | Range | Units | Description |
|----------|-------|------|---------|---------|-------|-------|-------------|
| **InputA** | `probe_monitor_feedback` | — | s16 | `0` | -5000 – 5000 | mV | Signed probe current monitor; negative indicates rising current draw |
| **CR8** | `monitor_enable` | [0] | boolean | `true` | — | — | Enable probe monitor threshold evaluation |
| **CR8** | `monitor_expect_negative` | [1] | boolean | `true` | — | — | True when a negative-going crossing counts as "probe fired" |
| **CR9** | `monitor_threshold_voltage` | [15:0] | s16 | `-200` | -5000 – 5000 | mV | Threshold (mV) the monitor must cross within the observation window |
| **CR10** | `monitor_window_start` | [31:0] | u32 | `0` | 0 – 2×10⁹ | ns | Delay after trigger before monitoring window opens |
| **CR11** | `monitor_window_duration` | [31:0] | u32 | `5000` | 100 – 2×10⁹ | ns | Length of monitoring window starting at `monitor_window_start` |

---

## Typical Operation Sequence

1. **Configure outputs:** Set `trig_out_voltage`, `trig_out_duration`, `intensity_voltage`, `intensity_duration`, and `cooldown_interval`.
2. **Tune monitoring:** Define `monitor_threshold_voltage`, `monitor_window_start`, and `monitor_window_duration`. Adjust polarity via `monitor_expect_negative`.
3. **Arm:** Assert `arm_enable` to transition FSM from IDLE → ARMED.
4. **Trigger:** External trigger (hardware) or `ext_trigger_in` (software) fires the pulse sequence.
5. **Cooldown:** FSM enforces `cooldown_interval` before returning to ARMED (if `auto_rearm_enable` is true) or IDLE.
6. **Fault handling:** If a fault occurs, clear via `fault_clear` before re-arming.

---

## Notes

- **Voltage encoding:** All voltage fields use millivolts (mV) for compatibility with Moku DAC/ADC expectations.
- **Timing precision:** Nanosecond fields (ns) for trigger/intensity pulses; microsecond (µs) for cooldown; seconds (s) for timeout.
- **Safety:** One-shot mode (`auto_rearm_enable = false`) is default to prevent runaway pulsing during bring-up.
- **Fault state:** Sticky faults require explicit acknowledgement (`fault_clear`) so the host can log and respond deliberately.

---

**Generated from:** `BPD-002v2.yaml` | **Forge codegen target**
